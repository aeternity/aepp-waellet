<template>
  <div class="popup">
    <div class="actions">
      <button class="backbutton toAccount" @click="navigateAccount"><ae-icon name="back" /> {{language.buttons.backToAccount}}</button>
    </div>
    <h3 class="flex flex-align-center">
      {{language.pages.send.heading}} 
      <ae-identicon class="send-account-icon" :address="account.publicKey" size="base" /> 
      {{activeAccountName}}
    </h3>
    <div class="sendContent">
      <ae-input :label="language.pages.send.recipient" class="address">
          <textarea class="ae-input textarea" v-model="form.address" placeholder="ak.. / name.test"  slot-scope="{ context }" @focus="context.focus = true" @blur="context.focus = false" />
      </ae-input>
      <div>
        <p v-if="sendSubaccounts">{{language.pages.send.sendSubaccount}}</p>
        <ae-list class="sendSubaccount">
          <ae-list-item v-for="(account,index) in sendSubaccounts" @click="selectSendSubaccount(account)" fill="neutral" :key="index" class=" flex-align-center">
            <ae-identicon class="subAccountIcon" v-bind:address="account.publicKey" size="base" />
            <div class="subAccountInfo flex flex-align-start flex-direction-column ">
              <div class="subAccountName">{{account.name}}</div>
              <div class="subAccountBalance">{{account.balance}} AE</div>
            </div>
          </ae-list-item>
        </ae-list>
      </div>
      
      <ae-input :label="language.strings.amount" placeholder="0.0" aemount v-model="form.amount" class="sendAmount">
        <ae-text slot="header" fill="black">
          <span class="token-symbol">{{tokenSymbol}}</span>
          <ae-dropdown v-if="tokens.length > 1">
            <ae-icon name="grid" size="20px" slot="button" />
            <li v-for="(tkn,key) in tokens" v-if="tkn.name != tokenSymbol" @click="setActiveToken(key)">
              <img :src="ae_token" class="token-image" alt="" v-if="key == 0" >
              <ae-identicon class="subAccountIcon" :address="tkn.contract" size="base" v-if="key != 0"/> {{tkn.name}}
            </li>
          </ae-dropdown>
        </ae-text>
        <ae-toolbar slot="footer" class="flex-justify-between">
          <span>
            {{language.strings.txFee}}
          </span>
          <span>
            {{txFee}} AE
          </span>
        </ae-toolbar>
      </ae-input>
      <div class="flex flex-justify-between balanceInfo">
          <div>
            {{language.strings.maxSpendableValue}}
          </div>
          <div class="balance no-sign">
            {{tokenBalance}} {{tokenSymbol}}
          </div>
      </div>
      
      <div>
        <ae-button face="round" fill="primary" class="sendBtn extend" @click="send">{{language.buttons.send}}</ae-button>
      </div>
    </div>
    <!-- <div v-if="loading" class="loading">
      <ae-loader />
    </div> -->
    <input type="hidden" class="txHash" :value="tx.hash" />
    <div class="result" v-if="tx.status">
      <p>{{language.strings.success}}</p>
      <a :href="tx.url">{{language.strings.seeTransactionExplorer}}</a>
    </div>
    <Loader size="big" :loading="loading" type="transparent" ></Loader>
    <popup :popupSecondBtnClick="popup.secondBtnClick"></popup>
  </div>
</template>

<script>
import { mapGetters } from 'vuex';
import locales from '../../locales/locales.json';
import QrcodeVue from 'qrcode.vue';
import Wallet from '@aeternity/aepp-sdk/es/ae/wallet';
import { MemoryAccount } from '@aeternity/aepp-sdk';
import { MAGNITUDE, calculateFee, TX_TYPES, FUNGIBLE_TOKEN_CONTRACT  } from '../../utils/constants';
import BigNumber from 'bignumber.js';
import Ae from '@aeternity/aepp-sdk/es/ae/universal';
import { getHdWalletAccount } from '../../utils/hdWallet';
import { contractEncodeCall, checkAddress, chekAensName } from '../../utils/helper';

export default {
  name: 'Send',
  data() {
    return {
      ae_token: browser.runtime.getURL('../../../icons/ae.png'),
      language: locales['en'],
      form: {
        address: '',
        amount: '',
      },
      loading: false,
      tx: {
        status: false,
        hash: '',
        block: '',
        url: ''
      },
      fee: {
        min:0,
        max:0
      }
    }
  },
  locales,
  watch: {
    activeToken() {
      this.fetchFee()
    }
  },
  computed: {
    ...mapGetters(['account', 'balance', 'network', 'current', 'wallet', 'activeAccount', 'subaccounts', 'tokenSymbol', 'tokenBalance', 'sdk', 'tokens', 'popup','activeAccountName']),
    maxValue() {
      let calculatedMaxValue = this.balance - this.maxFee
      return calculatedMaxValue > 0 ? calculatedMaxValue.toString() : 0;
    },
    sendSubaccounts() {
      let subs = this.subaccounts.filter(sub => sub.publicKey != this.account.publicKey);
      return subs.length == 0 ? false : subs;
    },
    txFee() {
      return this.fee.min
    },
    maxFee() {
      return this.fee.max
    },
    activeToken() {
      return this.current.token
    }
  },
  async mounted() {
    this.init()
    this.fetchFee()
  },
  methods: {
    paste(){

    },
    setActiveToken(token) {
      this.current.token = token
      this.$store.commit('RESET_TRANSACTIONS',[]);
    },
    async fetchFee() {
      let fee = await calculateFee(this.current.token == 0 ? TX_TYPES['txSign'] : TX_TYPES['contractCall'],{...await this.feeParams()})
      this.fee = fee
    },
    async feeParams() {
      if(this.current.token == 0) {
        return {
          ...this.sdk.Ae.defaults
        }
      }else {
        return {
          ...this.sdk.Ae.defaults,
          callerId:this.account.publicKey,
          contractId:this.tokens[this.current.token].contract,
          callData: await contractEncodeCall(this.sdk,FUNGIBLE_TOKEN_CONTRACT,"transfer",[this.account.publicKey,"0"])
        }
      }
    },
    send(){
      let amount = BigNumber(this.form.amount).shiftedBy(MAGNITUDE);
      let receiver = this.form.address;
      if(receiver == '' || (!checkAddress(receiver) && !chekAensName(receiver) ) )  {
        this.$store.dispatch('popupAlert', { name: 'spend', type: 'incorrect_address'});
        this.loading = false;
        return;
      }
      if(this.form.amount <= 0) {
        this.$store.dispatch('popupAlert', { name: 'spend', type: 'incorrect_amount'});
        this.loading = false;
        return;
      }
      //is the amount correct
      if (this.maxValue - this.form.amount <= 0 && this.current.token == 0) {
        this.$store.dispatch('popupAlert', { name: 'spend', type: 'insufficient_balance'});
        this.loading = false;
        return;
      } 
      if(this.current.token != 0 ) {
        if(this.maxValue - this.txFee <= 0) {
          this.$store.dispatch('popupAlert', { name: 'spend', type: 'insufficient_balance'});
          this.loading = false;
          return;
        }
        if(this.tokenBalance - this.form.amount <= 0) {
          this.$store.dispatch('popupAlert', { name: 'spend', type: 'insufficient_balance'});
          this.loading = false;
          return;
        }
        let tx = {
          popup:false,
          tx: {
            source:FUNGIBLE_TOKEN_CONTRACT,
            method:'transfer', 
            params: [receiver,this.form.amount],
            address:this.tokens[this.current.token].contract,
            amount:this.form.amount,
            token:this.tokenSymbol
          },
          type:'contractCall'
        }
        this.$store.commit('SET_AEPP_POPUP',true)
        this.$router.push({'name':'sign', params: {
          data:tx
        }});
      }
      else {
        let tx = {
          popup:false,
          tx: {
            amount:this.form.amount,
            recipientId:receiver
          },
          type:'txSign'
        }
        this.$store.commit('SET_AEPP_POPUP',true)
        this.$router.push({'name':'sign', params: {
          data:tx
        }});
     } 
    },
    init() {
      let calculatedMaxValue = this.balance - this.maxFee
    },
    clearForm () {
      setTimeout(() => {
        this.loading = false;
        this.tx.status = false;
        this.form.address = '';
        this.form.amount = '';
      }, 2000);
    },
    navigateAccount() {
      this.$router.push('/account')
    },
    openExplorer(url) {
      browser.tabs.create({url,active:false});
    },
    selectSendSubaccount(account) {
      this.form.address = account.publicKey;
    }
  }
}
</script>

<style lang="scss" scoped>
@import '../../../common/base';
.sendContent > div:not(.sendAmount):not(.address) { 
  margin-bottom: 10px;
}
.sendContent > div {
  overflow: unset;
}
.balanceInfo {
  margin-top:10px;
}
.token-symbol {
  margin-right: 2rem;
}
.ae-dropdown-button {
  width:16px !important;
  height:16px !important;
}
.sendContent .ae-dropdown {
  margin-bottom:0 !important;
}
.ae-input-container .ae-input-box {
  background: #fff !important;
  border: solid 2px #dcdcdc;
  border-radius: 10px;
}
.address {
  position: relative;
  // background: #ececec;
}
.address:focus-within { border-left: #FF0D6A 2px solid; }
.address:focus-within {
  p:not(.ae-text)  { color: #ff0d6a; }
  p:after:not(.ae-text)  { content: '*'; color:#ff0d6a; }
}
.address textarea {
  background: none;
  border: none;
  font-size: 20px;
  outline: none;
  text-align: center;
  font-family: "IBM Plex Mono", monospace;
  font-size: 1.0625rem;
  line-height: 1.5rem;
  font-weight: bold;
}
.address p:not(.ae-text) {
    position: absolute;
    top: 0;
    left: 0;
    font-size: 11px;
    color: #76818c;
    font-weight: 100;
    width: 100%;
    text-align: left;
    padding-left: 15px;
    background: #ececec;
}
.sendSubaccount .ae-list-item {
  cursor:pointer !important;
}
.paste {
  cursor: pointer;
  .ae-icon {
    margin-right:2px;
    display: inline-block;
  }
}
.send-account-icon {
  margin:0 10px;
}
</style>